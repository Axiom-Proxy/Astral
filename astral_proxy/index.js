const http=require("http"),https=require("https"),fs=require("fs"),zlib=require("zlib"),querystring=require("querystring"),WebSocket=require("ws");module.exports=class t{constructor(t="/astral/",e={}){this.prefix=t,this.config=e,this.proxifyRequestURL=(t,e)=>e?atob(t.split("_").slice(1).splice(0,1).join())+t.split("_").slice(2).join("_"):`_${btoa(t.split("/").splice(0,3).join("/"))}_/${t.split("/").splice(3).join("/")}`,t.startsWith("/")||(this.prefix="/"+t),t.endsWith("/")||(this.prefix=t+"/")}http(t,e,r=()=>e.end("")){if(!t.url.startsWith(this.prefix))return r();if(t.path=t.url.replace(this.prefix.slice(1),""),t.pathname=t.path.split("#")[0].split("?")[0],"/client_hook"==t.pathname||"/client_hook/"==t.pathname)return e.end(fs.readFileSync(__dirname+"/window.js","utf-8"));try{new URL(this.proxifyRequestURL(t.path,!0))}catch{return e.end("URL Parse Error")}var i={href:this.proxifyRequestURL(t.path,!0),origin:this.proxifyRequestURL(t.path,!0).split("/").splice(0,3).join("/"),hostname:this.proxifyRequestURL(t.path,!0).split("/").splice(0,3).slice(2).join("/")},s={},a=!1,o=i.href.startsWith("https://")?https:http,c={headers:Object.assign({},t.headers),method:t.method,rejectUnauthorized:!1};if(!(i.href.startsWith("https://")||i.href.startsWith("http://")))return e.end("URL Parse Error");if(delete c.headers.host,"object"==typeof this.config.blacklist&&0!=this.config.blacklist.length&&this.config.blacklist.forEach(t=>a=i.hostname==t),a)return e.end("The URL you are trying to access is not permitted for use.");if(!t.path.startsWith(`/_${btoa(i.origin)}_/`))return e.writeHead(308,{location:this.prefix+`_${btoa(i.origin)}_/`}),e.end("");if(c.headers.origin){var l=this.proxifyRequestURL(`/${c.headers.origin.split("/").splice(3).join("/")}`.replace(this.prefix,""),!0);l=l.startsWith("https://")||l.startsWith("http://")?l.split("/").splice(0,3).join("/"):i.origin,c.headers.origin=l}if(c.headers.referer){var l=this.proxifyRequestURL("/"+c.headers.referer.split("/").splice(3).join("/").replace(this.prefix,""),!0);l.startsWith("https://")||l.startsWith("http://")||(l=i.href),c.headers.referer=l}if(c.headers.cookie){var n=[];c.headers.cookie.split("; ").forEach(t=>{let e=t.split("=").splice(0,1).join(),r=t.split("=").splice(1).join();i.hostname.includes(e.split("@").splice(1).join())&&n.push(e.split("@").splice(0,1).join()+"="+r)}),c.headers.cookie=n.join("; ")}"object"==typeof this.config.localAddress&&0!=this.config.localAddress.length&&(c.localAddress=this.config.localAddress[Math.floor(Math.random()*this.config.localAddress.length)]);var h=o.request(i.href,c,r=>{var a=[],o="";r.on("data",t=>a.push(t)).on("end",()=>{let c={prefix:this.prefix,url:i.href};if(s.url=t=>t.match(/^(#|about:|data:|blob:|mailto:|javascript:|{|\*)/)?t:"https:"==(t=new URL(t.startsWith("//")?"http:"+t:t.startsWith("/")?i.origin+t:t.startsWith("https://")||t.startsWith("http://")?t:i.href.split("/").slice(0,-1).join("/")+"/"+t)).protocol||"http:"==t.protocol?this.prefix+this.proxifyRequestURL(t.href):t.href,s.js=t=>t.toString().replace(/(,| |=|\()document.location(,| |=|\)|\.)/gi,t=>t.replace(".location",".astralLocation")).replace(/(,| |=|\()window.location(,| |=|\)|\.)/gi,t=>t.replace(".location",".astralLocation")).replace(/(,| |=|\()location(,| |=|\)|\.)/gi,t=>t.replace("location","astralLocation")),s.css=t=>t.replace(/url\("(.*?)"\)/gi,t=>`url("${s.url(t.replace(/url\("(.*?)"\)/gi,"$1"))}")`).replace(/url\('(.*?)'\)/gi,t=>`url('${s.url(t.replace(/url\('(.*?)'\)/gi,"$1"))}')`).replace(/url\((.*?)\)/gi,t=>{var e=t.replace(/url\((.*?)\)/gi,"$1");return e.startsWith('"')||e.startsWith("'")?t:`url("${s.url(e)}")`}).replace(/@import (.*?)"(.*?)";/gi,t=>`@import "${s.url(t.replace(/@import (.*?)"(.*?)";/,"$2"))}";`).replace(/@import (.*?)'(.*?)';/gi,t=>`@import '${s.url(t.replace(/@import (.*?)'(.*?)';/,"$2"))}';`),s.html=t=>{let e=new(require("./dom")).JSDOM(t,{contentType:"text/html"}),r=e.window.document;var a=!1;r.querySelector("head base")&&(a=r.querySelector("head base").getAttribute("href")),a&&((a.includes("#")||a.includes("?"))&&(a=a.split("#")[0].split("?")[0]),a.startsWith("//")&&(a="http:"+a),a=a.startsWith("https://")||a.startsWith("http://")?new URL(a).href:a.startsWith("/")?new URL(i.origin+a).href:new URL(i.href.split("/").slice(0,-1).join("/")+"/"+a).href,c.baseURL=a),s.attribute=t=>t.startsWith("https://")||t.startsWith("http://")||t.startsWith("//")||!a?s.url(t):t=t.startsWith("/")?s.url(a.split("/").splice(0,3).join("/")+t):s.url(a.split("/").slice(0,-1).join("/")+"/"+t),r.querySelectorAll("*").forEach(t=>{t.getAttribute("nonce")&&t.removeAttribute("nonce"),t.getAttribute("integrity")&&t.removeAttribute("integrity"),t.getAttribute("style")&&t.setAttribute("style",s.css(t.getAttribute("style")))}),r.querySelectorAll("script, embed, iframe, frame, audio, video, img, input, source, track").forEach(t=>{t.src&&(t.src=s.attribute(t.src)),"script"==t.tagName.toLowerCase()&&""!=t.innerHTML&&(t.innerHTML=s.js(t.innerHTML))}),r.querySelectorAll("object").forEach(t=>{t.data&&(t.data=s.attribute(t.data)),t.codebase&&(t.codebase=s.attribute(t.codebase))}),r.querySelectorAll("applet").forEach(t=>{t.code&&(t.code=s.attribute(t.code)),t.codebase&&(t.codebase=s.attribute(t.codebase)),t.archive&&(t.archive=s.attribute(t.archive))}),r.querySelectorAll("param").forEach(t=>{t.value&&("movie"===t.name||"src"===t.name||"url"===t.name||"data"===t.name)&&(t.value=s.attribute(t.value))}),r.querySelectorAll("img[srcset], source[srcset]").forEach(t=>{var e=[];t.srcset.split(",").forEach(t=>{(t=t.trimStart().split(" "))[0]=s.attribute(t[0]),e.push(t.join(" "))}),t.srcset=e.join(", ")}),r.querySelectorAll("video[poster]").forEach(t=>{t.poster&&(t.poster=s.attribute(t.poster))}),r.querySelectorAll("a, link, area").forEach(t=>{t.href&&(t.href=s.attribute(t.href))}),r.querySelectorAll("base").forEach(t=>t.href=s.attribute(t.href)),r.querySelectorAll("form").forEach(t=>{t.action&&(t.action=s.attribute(t.action))}),r.querySelectorAll("button[formaction], input[formaction]").forEach(t=>{t.formaction&&(t.formaction=s.attribute(t.formaction))}),r.querySelectorAll("blockquote[cite], q[cite], del[cite], ins[cite]").forEach(t=>{t.cite&&(t.cite=s.attribute(t.cite))}),r.querySelectorAll("html[manifest]").forEach(t=>{t.manifest&&(t.manifest=s.attribute(t.manifest))}),r.querySelectorAll('link[rel*="icon"]').forEach(t=>{t.href&&(t.href=s.attribute(t.href))}),r.querySelectorAll('link[rel="preload"], link[rel="prefetch"], link[rel="preconnect"], link[rel="dns-prefetch"], link[rel="modulepreload"]').forEach(t=>{t.href&&(t.href=s.attribute(t.href))}),r.querySelectorAll('script[type="importmap"]').forEach(t=>{try{let e=JSON.parse(t.innerHTML);e.imports&&Object.keys(e.imports).forEach(t=>{(e.imports[t].startsWith("http")||e.imports[t].startsWith("/"))&&(e.imports[t]=s.attribute(e.imports[t]))}),e.scopes&&Object.keys(e.scopes).forEach(t=>{Object.keys(e.scopes[t]).forEach(r=>{(e.scopes[t][r].startsWith("http")||e.scopes[t][r].startsWith("/"))&&(e.scopes[t][r]=s.attribute(e.scopes[t][r]))})}),t.innerHTML=JSON.stringify(e)}catch(r){}}),r.querySelectorAll('meta[http-equiv="refresh"]').forEach(t=>{if(t.content){let e=t.content,r=e.match(/url=(.+)$/i);if(r){let i=s.attribute(r[1]);t.content=e.replace(/url=.+$/i,"url="+i)}}}),r.querySelectorAll('link[rel="manifest"]').forEach(t=>{t.href&&(t.href=s.attribute(t.href))}),r.querySelectorAll("img[longdesc], frame[longdesc], iframe[longdesc]").forEach(t=>{t.longdesc&&(t.longdesc=s.attribute(t.longdesc))}),r.querySelectorAll("head[profile]").forEach(t=>{t.profile&&(t.profile=s.attribute(t.profile))}),r.querySelectorAll("[background]").forEach(t=>{t.background&&(t.background=s.attribute(t.background))}),r.querySelectorAll("object[archive]").forEach(t=>{if(t.archive){let e=t.archive.split(" ").map(t=>s.attribute(t.trim()));t.archive=e.join(" ")}}),r.querySelectorAll("img[usemap], object[usemap]").forEach(t=>{t.usemap&&(t.usemap.startsWith("http")||t.usemap.startsWith("//"))&&(t.usemap=s.attribute(t.usemap))}),r.querySelectorAll("*").forEach(t=>{Array.from(t.attributes).forEach(e=>{if((e.name.startsWith("data-")&&(e.name.includes("url")||e.name.includes("src")||e.name.includes("href")||e.name.includes("link")||e.name.includes("path")||e.name.includes("endpoint"))||"data-background"===e.name||"data-bg"===e.name||"data-image"===e.name)&&e.value&&(e.value.startsWith("http")||e.value.startsWith("//")||e.value.startsWith("/")))try{t.setAttribute(e.name,s.attribute(e.value))}catch(r){}})}),r.querySelectorAll("style").forEach(t=>{t.textContent=s.css(t.textContent)});let o=r.createElement("script");return o.src=this.prefix+"client_hook",o.setAttribute("data-astral-config",btoa(JSON.stringify(c))),r.querySelector("head").insertBefore(o,r.querySelector("head").childNodes[0]),e.serialize()},0!=a.length)switch(r.headers["content-encoding"]){case"gzip":o=zlib.gunzipSync(Buffer.concat(a));break;case"deflate":o=zlib.inflateSync(Buffer.concat(a));break;case"br":o=zlib.brotliDecompressSync(Buffer.concat(a));break;default:o=Buffer.concat(a)}Object.entries(r.headers).forEach(([e,a])=>{if("set-cookie"==e){let o=[];a.forEach(e=>o.push(e.replace(/Domain=(.*?);/gi,"Domain="+t.headers.host+";").replace(/(.*?)=(.*?);/,"$1@"+i.hostname+"=$2;"))),r.headers[e]=o}(e.startsWith("content-encoding")||e.startsWith("x-")||e.startsWith("cf-")||e.startsWith("strict-transport-security")||e.startsWith("content-security-policy")||e.startsWith("content-length"))&&delete r.headers[e],"location"==e&&(r.headers[e]=s.url(a))}),r.headers["content-type"]&&r.headers["content-type"].startsWith("text/html")?o=s.html(o.toString()):r.headers["content-type"]&&(r.headers["content-type"].startsWith("application/javascript")||r.headers["content-type"].startsWith("text/javascript"))?o=s.js(o.toString()):r.headers["content-type"]&&r.headers["content-type"].startsWith("text/css")&&(o=s.css(o.toString())),e.writeHead(r.statusCode,r.headers),e.end(o)})});h.on("error",t=>e.end(t.toString())),e.writableEnded||t.on("data",t=>h.write(t)).on("end",()=>h.end())}ws(t){new WebSocket.Server({server:t}).on("connection",(t,e)=>{var r,i=querystring.parse(e.url.split("?").splice(1).join("?")),s={headers:{},followRedirects:!0},a=[];if(!i.ws)return t.close();r=atob(i.ws);try{new URL(r)}catch{return t.close()}Object.entries(e.headers).forEach(([t,e])=>{"sec-websocket-protocol"==t&&e.split(", ").forEach(t=>a.push(t)),t.startsWith("cf-")||t.startsWith("cdn-loop")||t.startsWith("sec-websocket")||(s.headers[t]=e)}),i.origin&&(s.origin=atob(i.origin),s.headers.origin=atob(i.origin)),delete s.headers.host,delete s.headers.cookie,"object"==typeof this.config.localAddress&&0!=this.config.localAddress.length&&(s.localAddress=this.config.localAddress[Math.floor(Math.random()*this.config.localAddress.length)]);let o=new WebSocket(r,a,s),c=[];0==o.readyState&&t.on("message",t=>c.push(t)),t.on("close",()=>o.close()),o.on("close",()=>t.close()),t.on("error",()=>o.terminate()),o.on("error",()=>t.terminate()),o.on("open",()=>{0!=c.length&&c.forEach(t=>o.send(t)),t.on("message",t=>o.send(t)),o.on("message",e=>t.send(e))})})}};