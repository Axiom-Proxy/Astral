const http=require("http"),https=require("https"),fs=require("fs"),zlib=require("zlib"),querystring=require("querystring"),WebSocket=require("ws");module.exports=class{constructor(e="/astral/",t={}){this.prefix=e,this.config=t,e.startsWith("/")||(this.prefix="/"+e),e.endsWith("/")||(this.prefix+="/"),this.proxifyRequestURL=(e,t)=>t?atob(e.split("_").slice(1).splice(0,1).join())+e.split("_").slice(2).join("_"):`_${btoa(e.split("/").splice(0,3).join("/"))}_/${e.split("/").splice(3).join("/")}`}http(e,t,s=()=>t.end("")){if(!e.url.startsWith(this.prefix))return s();if(e.path=e.url.replace(this.prefix.slice(1),""),e.pathname=e.path.split("#")[0].split("?")[0],"/client_hook"===e.pathname||"/client_hook/"===e.pathname)return t.end(fs.readFileSync(__dirname+"/window.js","utf-8"));try{new URL(this.proxifyRequestURL(e.path,!0))}catch{return t.end("URL Parse Error")}let r={href:this.proxifyRequestURL(e.path,!0),origin:this.proxifyRequestURL(e.path,!0).split("/").splice(0,3).join("/"),hostname:this.proxifyRequestURL(e.path,!0).split("/").splice(0,3).slice(2).join("/")},i=r.href.startsWith("https://")?https:http,o={headers:{...e.headers},method:e.method,rejectUnauthorized:!1};if(!r.href.startsWith("http://")&&!r.href.startsWith("https://"))return t.end("URL Parse Error");delete o.headers.host;let n=this.config.blacklist?.some(e=>r.hostname===e);if(n)return t.end("The URL you are trying to access is not permitted for use.");if(!e.path.startsWith(`_${btoa(r.origin)}_/`))return t.writeHead(308,{location:this.prefix+`_${btoa(r.origin)}_/${e.pathname}`}),t.end("");let h={origin:this.proxifyRequestURL(e.path,!0).split("/").splice(0,3).join("/")};if(o.headers.referer&&(o.headers.referer=this.proxifyRequestURL("/"+o.headers.referer.split("/").splice(3).join("/"),!0)),h.origin,o.headers.origin&&(o.headers.origin=this.proxifyRequestURL(`/${o.headers.origin.split("/").splice(3).join("/")}`,!0)),o.headers.cookie){let a=[];o.headers.cookie.split("; ").forEach(e=>{let[t,s]=e.split("="),i=t.split("@").join("")||t,o=s.replace(/Domain=(.*?);/gi,`Domain=${r.hostname};`).replace(/\s*=[^;]+;$/,"$1@$"+r.hostname+"=$2;");a.push(`${i}=${o}`)}),o.headers.cookie=a.join("; ")}this.config.localAddress?.length&&(o.localAddress=this.config.localAddress[Math.floor(Math.random()*this.config.localAddress.length)]);let l=i.request(r.href,o,e=>{let s=[],i="";e.on("data",e=>s.push(e)).on("end",()=>{this.prefix,r.href,i+=zlib.gunzipSync(Buffer.concat(s))}),e.on("error",e=>t.end(e.toString())),Object.entries(e.headers).forEach(([t,s])=>{if("set-cookie"===t){let i=[];for(let n of s)o.headers.origin||r.href,i.push(n.replace(/Domain=(.*?);/gi,`Domain=${r.hostname};`).replace(/\s*=[^;]+;$/,"$1@$"+r.hostname+"=$2;"));e.headers[t]=i}if("location"===t){let h=new URL(e.headers.location).href;e.headers.location=proxifyUrl(h)}t.startsWith("content-encoding")&&(e.headers[t]=s.replace(/(gzip|deflate)/gi,""))}),e.headers["content-type"]&&e.headers["content-type"].startsWith("text/html")?i+=proxify.html(i.toString()):e.headers["content-type"]&&e.headers["content-type"].startsWith("application/javascript")||e.headers["content-type"]&&e.headers["content-type"].startsWith("text/javascript")?i+=proxify.js(i.toString()):e.headers["content-type"]&&e.headers["content-type"].startsWith("text/css")&&(i+=proxify.css(i.toString())),t.writeHead(e.statusCode,e.headers),t.end(i)});l.on("error",e=>t.end(e.toString()))}ws(e){new WebSocket.Server({server:e}).on("connection",(e,t)=>{let s=querystring.parse(t.url.split("?").splice(1).join("?"));if(!s.ws)return e.close();let r=atob(s.ws);try{new URL(r)}catch{return e.close()}let i={headers:{},followRedirects:!0};for(let[o,n]of Object.entries(t.headers))"sec-websocket-protocol"===o?n.split(", ").forEach(e=>i.protocol.push(e)):o.startsWith("sec-websocket")||(i.headers[o]=n);delete i.headers.host,delete i.headers.cookie;let h=new WebSocket(r,i.protocol,i),a=[];0===h.readyState&&e.on("message",e=>a.push(e)),e.on("close",()=>h.close()),h.on("close",()=>e.close()),e.on("error",()=>h.terminate()),h.on("error",()=>e.terminate()),h.on("open",()=>{a.length&&a.forEach(e=>h.send(e)),e.on("message",e=>h.send(e)),h.on("message",t=>e.send(t))})})}};